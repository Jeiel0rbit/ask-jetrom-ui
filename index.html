<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ask Jetrom</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#4285f4">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark-dimmed.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<link rel="manifest" href="/ask-jetrom-ui/manifest.json">
<style>
#install-modal {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  background-color: #fff;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: none;
  align-items: center;
  gap: 15px;
}
#install-modal p {
  margin: 0;
  font-size: 1rem;
  color: #333;
}
#install-modal button {
  border: none;
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
}
#install-btn {
  background-color: #4285f4;
  color: white;
}
#close-modal-btn {
  background-color: #eee;
  color: #333;
}
:root {
--primary-color: #4285f4;
--secondary-color: #34a853;
--accent-color: #ea4335;
--light-bg: #f8f9fa;
--dark-text: #202124;
--card-bg: #ffffff;
--border-color: #e0e0e0;
}

body {
background-color: var(--light-bg);
background-image: radial-gradient(circle at 1% 1%, rgba(66, 133, 244, 0.05), rgba(255, 255, 255, 0) 25%);
font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
color: var(--dark-text);
line-height: 1.6;
padding-bottom: 80px;
}

.card {
background-color: var(--card-bg);
border: 1px solid var(--border-color);
border-radius: 16px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.07);
transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
transform: translateY(-5px);
box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
}

.card-title {
color: var(--dark-text);
font-weight: 700;
position: relative;
padding-bottom: 10px;
}

.card-title::after {
content: '';
position: absolute;
bottom: 0;
left: 50%;
transform: translateX(-50%);
width: 50px;
height: 4px;
border-radius: 2px;
background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
}

.btn-primary {
background: linear-gradient(90deg, var(--primary-color), #3367d6);
border: none;
padding: 12px;
font-weight: 600;
letter-spacing: 0.5px;
transition: all 0.3s ease;
background-size: 200% 100%;
}

.btn-primary:hover {
background-position: right center;
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
}

#resposta {
background-color: var(--card-bg);
border: 1px solid var(--border-color) !important;
border-radius: 8px;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
white-space: pre-wrap;
transition: all 0.3s ease;
min-height: 150px;
padding: 1rem;
}

#resposta:empty:not(:focus)::before {
content: "A resposta demora cerca de 10 segundos ou menos!";
color: #999;
padding: 1rem;
display: block;
margin: -1rem;
}

#resposta.markdown-rendered {
white-space: normal;
}

pre {
position: relative;
background-color: #22272e !important;
border-radius: 8px !important;
padding: 16px !important;
overflow: auto !important;
font-size: 0.9em;
}

.copy-btn {
position: absolute;
top: 12px;
right: 12px;
background-color: rgba(255, 255, 255, 0.1);
color: #fff;
border: 1px solid rgba(255, 255, 255, 0.2);
border-radius: 6px;
padding: 5px 10px;
font-size: 12px;
cursor: pointer;
display: flex;
align-items: center;
gap: 6px;
transition: all 0.2s ease;
z-index: 10;
}

.copy-btn:hover {
background-color: rgba(255, 255, 255, 0.2);
border-color: rgba(255, 255, 255, 0.3);
}

.copy-btn.copied {
background-color: var(--secondary-color);
border-color: var(--secondary-color);
color: #fff;
}

#resposta code:not(pre code) {
font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
background-color: rgba(175, 184, 193, 0.2);
border-radius: 3px;
padding: 0.2em 0.4em;
font-size: 85%;
}

#resposta blockquote {
border-left: 4px solid #dfe2e5;
color: #6a737d;
padding: 0 1em;
margin-left: 0;
}

.form-control:focus {
border-color: var(--primary-color);
box-shadow: 0 0 0 0.25rem rgba(66, 133, 244, 0.25);
}

.loading {
position: relative;
color: transparent;
}

.loading::after {
content: '';
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 20px;
height: 20px;
border: 3px solid rgba(66, 133, 244, 0.2);
border-top-color: var(--primary-color);
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
to { transform: translate(-50%, -50%) rotate(360deg); }
}

footer {
text-align: center;
padding: 20px 0;
color: #666;
font-size: 0.9rem;
position: fixed;
bottom: 0;
width: 100%;
background-color: var(--light-bg);
border-top: 1px solid #dee2e6;
}

@media (max-width: 768px) {
body { padding-bottom: 70px; }
.container { padding-top: 1rem; padding-bottom: 1rem; }
.card { border-radius: 12px; }
.card-body { padding: 1.25rem; }
.btn-primary { padding: 10px; }
#resposta { min-height: 120px; }
}
</style>
</head>
<body>

<div class="container py-4 py-md-5">
<div class="row justify-content-center">
<div class="col-12 col-md-10 col-lg-8">
<div class="card">
<div class="card-body p-4 p-md-5">
<h1 class="card-title text-center mb-4">Jetrom</h1>

<div class="mb-4">
<label for="prompt" class="form-label fw-semibold">Prompt:</label>
<input type="text" class="form-control py-2" id="prompt" placeholder="Digite algo..." autofocus>
</div>

<button onclick="gerarTexto()" class="btn btn-primary w-100 mb-4 py-2">
<i class="bi bi-robot"></i> Ask
</button>

<div class="mt-3">
<label class="form-label fw-semibold">Resposta:</label>
<div id="resposta" class="bg-white"></div>
</div>
</div>
</div>
</div>
</div>
</div>

<footer>
<div class="container">
<p class="m-0">© <span id="current-year"></span> Ask Jetrom. Todos os direitos reservados.</p>
</div>
</footer>

<div id="install-modal">
  <p>Instale o Ask Jetrom para acesso fácil!</p>
  <button id="install-btn">Instalar</button>
  <button id="close-modal-btn">Agora não</button>
</div>

<script>
marked.setOptions({
breaks: true,
gfm: true,
highlight: function(code, lang) {
const language = hljs.getLanguage(lang) ? lang : 'plaintext';
return hljs.highlight(code, { language }).value;
}
});

function addCopyButtons() {
const codeBlocks = document.querySelectorAll('#resposta pre');
codeBlocks.forEach((preElement) => {
if (preElement.querySelector('.copy-btn')) return;

const codeElement = preElement.querySelector('code');
if (!codeElement) return;

const copyBtn = document.createElement('button');
copyBtn.className = 'copy-btn';
copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copiar';

copyBtn.addEventListener('click', () => {
const codeToCopy = codeElement.innerText;
navigator.clipboard.writeText(codeToCopy).then(() => {
copyBtn.innerHTML = '<i class="bi bi-check2"></i> Copiado!';
copyBtn.classList.add('copied');
setTimeout(() => {
copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copiar';
copyBtn.classList.remove('copied');
}, 2000);
}).catch(err => {
console.error('Falha ao copiar texto: ', err);
copyBtn.innerHTML = 'Erro';
});
});

preElement.appendChild(copyBtn);
});
}

async function gerarTexto() {
const prompt = document.getElementById("prompt").value;
const resposta = document.getElementById("resposta");

if (!prompt.trim()) {
resposta.textContent = "Por favor, digite um prompt válido.";
return;
}

resposta.innerHTML = "";
resposta.classList.add("loading");
resposta.classList.remove("markdown-rendered");

try {
const apiUrl = "https://ask-jetrom.vercel.app/generate";
const res = await fetch(apiUrl, {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ prompt })
});

const responseText = await res.text();
if (!res.ok) {
let errorMsg = `Erro ${res.status}: ${res.statusText}`;
try {
const errorJson = JSON.parse(responseText);
errorMsg = errorJson.error || errorJson.message || responseText;
} catch (e) {
errorMsg = responseText || errorMsg;
}

if (res.status === 429) {
errorMsg = "Limite de requisições excedido. Por favor, tente novamente mais tarde.";
} else if (res.status === 401) {
    errorMsg = "Erro de autenticação. Verifique a API Key.";
}

throw new Error(errorMsg);
}

let result;
try {
result = JSON.parse(responseText);
} catch (e) {
throw new Error("Resposta inválida do servidor. Esperava um JSON.");
}

const text = result.generated_text || "Não foi possível obter uma resposta.";

resposta.innerHTML = marked.parse(text);
resposta.classList.add("markdown-rendered");

document.querySelectorAll('#resposta pre code').forEach((block) => {
hljs.highlightElement(block);
});

addCopyButtons();

} catch (err) {
let displayMessage = "Erro: " + err.message;

if (err instanceof TypeError && (err.message === 'Failed to fetch' || err.message.includes('NetworkError'))) {
displayMessage = "Suas consultas chegaram ao fim. Tente novamente após 1 hora.";
}
resposta.textContent = displayMessage;
resposta.classList.remove("markdown-rendered");
console.error("Erro na requisição:", err);
} finally {
resposta.classList.remove("loading");
}
}

document.getElementById("prompt").addEventListener("keypress", function(event) {
if (event.key === "Enter") {
event.preventDefault();
document.querySelector(".btn-primary").click();
}
});

document.getElementById('current-year').textContent = new Date().getFullYear();

if ('serviceWorker' in navigator) {
  let deferredPrompt;
  const installModal = document.getElementById('install-modal');
  const installBtn = document.getElementById('install-btn');
  const closeModalBtn = document.getElementById('close-modal-btn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (!window.matchMedia('(display-mode: standalone)').matches) {
      installModal.style.display = 'flex';
    }
  });

  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('User accepted the install prompt');
      }
      deferredPrompt = null;
    }
    installModal.style.display = 'none';
  });

  closeModalBtn.addEventListener('click', () => {
    installModal.style.display = 'none';
  });

  navigator.serviceWorker.register('/sw.js')
    .then(registration => console.log('Service Worker registered with scope:', registration.scope))
    .catch(error => console.error('Service Worker registration failed:', error));

    window.addEventListener('appinstalled', () => {
        installModal.style.display = 'none';
    });
}
</script>

</body>
</html>
